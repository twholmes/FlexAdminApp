<Readers xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema">
	<Reader xsi:type="ExecuteOnTarget" 
			Name="CreateTargetTempUserTables" 
			Order="300" 
			Retries="1">
		<![CDATA[

			IF OBJECT_ID('TempDB..#AVPackageAssignment') IS NOT NULL
				DROP TABLE #AVPackageAssignment
							
			CREATE TABLE #AVPackageAssignment
			(
				PackageID	INT,
				ObjectSID	NVARCHAR(64) COLLATE database_default,
				ObjectType	NVARCHAR(32) COLLATE database_default
			)

			IF OBJECT_ID('TempDB..#User') IS NOT NULL
				DROP TABLE #User
							
			CREATE TABLE #User
			(
				ExternalUserID	INT,
				SAMAccountName	NVARCHAR(64) COLLATE database_default,
				DomainName		NVARCHAR(100) COLLATE database_default,	
				UserName		NVARCHAR(64) COLLATE database_default
			)
						
		]]>
	</Reader>

    <Reader 
			xsi:type="SourceToTarget"
			Name="GetPackageAssignments"
			Order="310"
			Retries="1"
			Method="GetPackageAssignments"
			Language="PowerShell"		
			Table="#AVPackageAssignment">

			<InputVariable Name="WebServicesURI" Variable="WebServicesURI"/>
			<InputVariable Name="Username" Variable="Username"/>
			<InputVariable Name="Password" Variable="Password"/>

			<OutputSchema Name="PackageID" Type="int" Property="PackageID" />				
			<OutputSchema Name="ObjectSID" Type="nvarchar" Length="64" Property="ObjectSID" />
			<OutputSchema Name="ObjectType" Type="nvarchar" Length="32" Property="ObjectType" />

	</Reader>

	<Reader xsi:type="ExecuteOnTarget" 
			Name="CreateIndexesOnAVPackageAssignment" 
			Order="320" 
			Retries="1">
		<![CDATA[
			CREATE INDEX IX_#AVPackageAssignment_PackageID ON #AVPackageAssignment(PackageID)
			CREATE INDEX IX_#AVPackageAssignment_ObjectSID ON #AVPackageAssignment(ObjectSID)			
		]]>
	</Reader>


	<Reader xsi:type="ExecuteOnTarget" 
			Name="GetUsers" 
			Order="330" 
			Retries="1">
		<![CDATA[

			INSERT INTO #User (
				ExternalUserID,
				SAMAccountName,
				DomainName,
				UserName
			)
			SELECT TOP 1 WITH TIES
				adu.ActiveDirectoryUserID,
				adu.SAMAccountName,
				ad.QualifiedName,
				LEFT(cu.UserName,64) AS UserName
			FROM
				dbo.ActiveDirectoryUser adu
				JOIN dbo.ActiveDirectoryDomain ad
					ON ad.ActiveDirectoryDomainID = adu.ActiveDirectoryDomainID
				JOIN dbo.ComplianceDomain cd
					ON cd.QualifiedName = ad.QualifiedName
				JOIN dbo.ComplianceUser cu
					ON 
						cu.SAMAccountName = adu.SAMAccountName
						AND 
						cu.ComplianceDomainID = cd.ComplianceDomainID
			WHERE EXISTS ( -- The package assignment is to a group and the user is a member of it
					SELECT 1
					FROM #AVPackageAssignment avpa
						JOIN #AVPackage avp
							ON avp.PackageID = avpa.PackageID
						INNER JOIN dbo.ActiveDirectoryChildObjects adco
							ON adco.RootGroupSID = avpa.ObjectSID
					WHERE 
						avpa.ObjectType = 'group'
						AND adco.ChildObjectGUID = adu.GUID
						AND	avp.Status = 'enabled'
				)
				OR EXISTS ( -- The package assignment is made directly to the user
					SELECT 1
					FROM #AVPackageAssignment avpa
						JOIN #AVPackage avp
							ON avp.PackageID = avpa.PackageID
					WHERE 
						avpa.ObjectType = 'user'
						AND avpa.ObjectSID = adu.SID
						AND	avp.Status = 'enabled'				
				)
			ORDER BY ROW_NUMBER() OVER (PARTITION BY adu.ActiveDirectoryUserID ORDER BY cu.ComplianceUserID)

			PRINT N'Found ' + CONVERT(NVARCHAR(1000), @@ROWCOUNT) + N' AD users that are members of Active Directory application assignment groups and exist as users in FNMS'

			CREATE INDEX IX_#User_ExternalUserID ON #User(ExternalUserID)
			CREATE INDEX IX_#User_SAMAccountName_DomainName ON #User(SAMAccountName, DomainName)

		]]>
	</Reader>

	<Reader xsi:type="ExecuteOnTarget" 
			Name="PersistUsers" 
			Order="340" 
			Retries="1">
		<![CDATA[

			DELETE iu
			FROM dbo.ImportedUser AS iu
			WHERE
				iu.ComplianceConnectionID = @ComplianceConnectionID
				AND NOT EXISTS (
					SELECT 'x'
					FROM #User AS adaau
					WHERE
						iu.ExternalID = adaau.ExternalUserID
				)
			
			PRINT N'Removed ' + CONVERT(NVARCHAR(1000), @@ROWCOUNT) + N' obsolete AD assigned user records'
			
			UPDATE iu
			SET
				iu.UserName = adaau.UserName,
				iu.SAMAccountName = adaau.SAMAccountName,
				iu.[Domain] = adaau.DomainName
			FROM dbo.ImportedUser AS iu
				JOIN #User AS adaau
					ON iu.ExternalID = adaau.ExternalUserID
			WHERE
				iu.ComplianceConnectionID = @ComplianceConnectionID
			
			PRINT N'Updated ' + CONVERT(NVARCHAR(1000), @@ROWCOUNT) + N' user records'

			INSERT INTO dbo.ImportedUser (
				ComplianceConnectionID,
				ExternalID,
				UserName,
				SAMAccountName,
				[Domain]
			)
			SELECT
				@ComplianceConnectionID,
				adaau.ExternalUserID AS ExternalID,
				adaau.UserName,
				adaau.SAMAccountName,
				adaau.DomainName AS Domain
			FROM #User AS adaau
			WHERE 
				NOT EXISTS (
					SELECT 'x'
					FROM dbo.ImportedUser AS iu
					WHERE
						iu.ComplianceConnectionID = @ComplianceConnectionID
						AND iu.ExternalID = adaau.ExternalUserID
				)
			
			PRINT N'Added ' + CONVERT(NVARCHAR(1000), @@ROWCOUNT) + N' new user records'

		]]>
	</Reader>

	<Reader xsi:type="ExecuteOnTarget"
			Name="RemoveTargetTempUserTables"
			Order="390"
			Retries="1">
		<![CDATA[

			IF OBJECT_ID('TempDB..#User') IS NOT NULL
				DROP TABLE #User

			-- Don't remove the #AVPackageAssignment table as it is needed in the InstallerEvidence procedure
		]]>
	</Reader>	
</Readers>