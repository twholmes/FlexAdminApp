<Readers xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema">
	<Reader xsi:type="ExecuteOnTarget" 
			Name="CreateTargetTables" 
			Order="200" 
			Retries="1">
		<![CDATA[
				
			IF OBJECT_ID('tempdb..#User') IS NOT NULL
				DROP TABLE #User
							
			CREATE TABLE #User
			(
				ExternalUserID	INT,
				SAMAccountName	NVARCHAR(64) COLLATE database_default,
				DomainName		NVARCHAR(100) COLLATE database_default,	
				UserName		NVARCHAR(64) COLLATE database_default
			)
						
		]]>
	</Reader>

	<Reader xsi:type="ExecuteOnTarget" 
			Name="GetUsers" 
			Order="210" 
			Retries="1">
		<![CDATA[
			
			INSERT INTO #User (
				ExternalUserID,
				SAMAccountName,
				DomainName,
				UserName
			)
			SELECT TOP 1 WITH TIES
				adu.ActiveDirectoryUserID,
				adu.SAMAccountName,
				ad.QualifiedName,
				LEFT(cu.UserName,64) AS UserName
			FROM
				ActiveDirectoryUser adu
				JOIN ActiveDirectoryDomain ad
					ON ad.ActiveDirectoryDomainID = adu.ActiveDirectoryDomainID
				JOIN dbo.ComplianceDomain cd
					ON cd.QualifiedName = ad.QualifiedName
				JOIN dbo.ComplianceUser cu
					ON 
						cu.SAMAccountName = adu.SAMAccountName
						AND 
						cu.ComplianceDomainID = cd.ComplianceDomainID
			WHERE EXISTS (
					SELECT 1
					FROM ActiveDirectoryChildObjects adco
						INNER JOIN #ADApplicationGroup tadag
							ON tadag.GUID = adco.RootGroupGUID
					WHERE adco.ChildObjectGUID = adu.GUID
				)
			ORDER BY ROW_NUMBER() OVER (PARTITION BY adu.ActiveDirectoryUserID ORDER BY cu.ComplianceUserID)

			PRINT N'Found ' + CONVERT(NVARCHAR(1000), @@ROWCOUNT) + N' AD users that are members of Active Directory application assignment groups and exist as users in FNMS'

			CREATE INDEX IX_#User_ExternalUserID ON #User(ExternalUserID)
			CREATE INDEX IX_#User_SAMAccountName_DomainName ON #User(SAMAccountName, DomainName)

		]]>
	</Reader>

	<Reader xsi:type="ExecuteOnTarget" 
			Name="PersistUsers" 
			Order="220" 
			Retries="1">
		<![CDATA[

			DELETE iu
			FROM dbo.ImportedUser AS iu
			WHERE
				iu.ComplianceConnectionID = @ComplianceConnectionID
				AND NOT EXISTS (
					SELECT 'x'
					FROM #User AS adaau
					WHERE
						iu.ExternalID = adaau.ExternalUserID
				)
			
			PRINT N'Removed ' + CONVERT(NVARCHAR(1000), @@ROWCOUNT) + N' obsolete AD assigned user records'
			
			UPDATE iu
			SET
				iu.UserName = adaau.UserName,
				iu.SAMAccountName = adaau.SAMAccountName,
				iu.[Domain] = adaau.DomainName
			FROM dbo.ImportedUser AS iu
				JOIN #User AS adaau
					ON iu.ExternalID = adaau.ExternalUserID
			WHERE
				iu.ComplianceConnectionID = @ComplianceConnectionID
			
			PRINT N'Updated ' + CONVERT(NVARCHAR(1000), @@ROWCOUNT) + N' user records'

			INSERT INTO dbo.ImportedUser (
				ComplianceConnectionID,
				ExternalID,
				UserName,
				SAMAccountName,
				[Domain]
			)
			SELECT
				@ComplianceConnectionID,
				adaau.ExternalUserID AS ExternalID,
				adaau.UserName,
				adaau.SAMAccountName,
				adaau.DomainName AS Domain
			FROM #User AS adaau
			WHERE 
				NOT EXISTS (
					SELECT 'x'
					FROM dbo.ImportedUser AS iu
					WHERE
						iu.ComplianceConnectionID = @ComplianceConnectionID
						AND iu.ExternalID = adaau.ExternalUserID
				)
			
			PRINT N'Added ' + CONVERT(NVARCHAR(1000), @@ROWCOUNT) + N' new user records'

		]]>
	</Reader>

</Readers>