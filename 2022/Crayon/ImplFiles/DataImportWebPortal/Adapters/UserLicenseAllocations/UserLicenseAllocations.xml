<?xml version="1.0" encoding="utf-8"?>
<root>
  <ManageSoft connectiontype="ecm" runintransaction="False" />
  <Imports>
    <Import Type="Excel" Name="UserLicenseAllocations" Template="" Enabled="False" ConnectionString="Provider=Microsoft.ACE.OLEDB.12.0;Data Source=FNMS-UserLicenseAllocationSpreadsheet-Template.xlsx;Extended Properties='Excel 12.0 Xml;HDR=Yes;IMEX=1'" Query="select * from ['License Allocations$']" TraceActions="created,deleted,updated,rejected" TraceFields="(ISNULL([License Name], '&lt;NULL&gt;') + '/' + ISNULL([User], '&lt;NULL&gt;'))" CleanUpControlCharOn="" datatablename="#LicenseAllocations">
      <Log Name="Log" Output="File" LogLevel="Debug" Content="All" FileName="Import-[IMPORT NAME]_[DATE][TIME].log" />
      <Object Type="Custom" Name="Validate Source Data" TimeOut="-1" Query="DECLARE @ImportObjectID INT&#xD;&#xA;EXEC @ImportObjectID = dbo.CustomAdapterValidationStartRules [LOG_IMPORT_ID], 'Validate Source Data'&#xD;&#xA;&#xD;&#xA;/* Validate operator can create records */&#xD;&#xA;EXEC dbo.CustomAdapterValidationRegisterRule&#xD;&#xA;	@ImportObjectID,&#xD;&#xA;	@IsGlobalRule = 1,&#xD;&#xA;	@ValidationRule = '&#xD;&#xA;		NOT EXISTS(&#xD;&#xA;			SELECT 1&#xD;&#xA;			FROM dbo.RightsHasAccess(''CMLicenseAlloc'', ''modify'')&#xD;&#xA;			WHERE HasAccess = 1&#xD;&#xA;		)&#xD;&#xA;	',&#xD;&#xA;	@ErrorMessage = 'You require rights to create license allocations to import this data'&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;/* Validate that values are provided in mandatory columns */&#xD;&#xA;EXEC dbo.CustomAdapterValidationRuleRequired @ImportObjectID, 'License Name'&#xD;&#xA;EXEC dbo.CustomAdapterValidationRuleRequired @ImportObjectID, 'User'&#xD;&#xA;&#xD;&#xA;/* Validate list values */&#xD;&#xA;EXEC dbo.CustomAdapterValidationRegisterRule&#xD;&#xA;	@ImportObjectID,&#xD;&#xA;	@ValidationRule = '&#xD;&#xA;		source.[@SourceColumn1Name@] != ''''&#xD;&#xA;		AND NOT EXISTS(&#xD;&#xA;			SELECT 1&#xD;&#xA;			FROM dbo.ResourceStringCultureType rsct&#xD;&#xA;				JOIN dbo.SoftwareLicenseExemptionReason list ON list.ResourceName = rsct.ResourceString&#xD;&#xA;			WHERE rsct.ResourceValue = source.[@SourceColumn1Name@]&#xD;&#xA;		)&#xD;&#xA;	',&#xD;&#xA;	@ErrorMessage = 'Invalid @SourceColumn1Name@ [@SourceColumn1Value@]',&#xD;&#xA;	@SourceColumn1Name = 'Exemption Reason'&#xD;&#xA;&#xD;&#xA;/* TODO: Validate that Number Allocated is numeric */&#xD;&#xA;&#xD;&#xA;/* Each source record must map to no more than one target record */&#xD;&#xA;EXEC dbo.CustomAdapterValidationRegisterRule&#xD;&#xA;	@ImportObjectID,&#xD;&#xA;	@ValidationRule = '&#xD;&#xA;		source.[@SourceColumn1Name@] != ''''&#xD;&#xA;		AND (SELECT COUNT(*) FROM dbo.SoftwareLicense sl WHERE sl.Name = source.[@SourceColumn1Name@]) &gt; 1&#xD;&#xA;	',&#xD;&#xA;	@ErrorMessage = 'There are multiple existing licenses with name [@SourceColumn1Value@]: cannot identify which record to update',&#xD;&#xA;	@SourceColumn1Name = 'License Name'&#xD;&#xA;&#xD;&#xA;EXEC dbo.CustomAdapterValidationRegisterRule&#xD;&#xA;	@ImportObjectID,&#xD;&#xA;	@ValidationRule = '&#xD;&#xA;		source.[@SourceColumn1Name@] != ''''&#xD;&#xA;		AND (SELECT COUNT(*) FROM dbo.ComplianceUser cu WHERE cu.Email = source.[@SourceColumn1Name@] OR cu.EmployeeNumber = source.[@SourceColumn1Name@]) &gt; 1&#xD;&#xA;	',&#xD;&#xA;	@ErrorMessage = 'There are multiple existing users with email address or employee number [@SourceColumn1Value@]: cannot identify which record to update',&#xD;&#xA;	@SourceColumn1Name = 'User'&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;/* Execute validation rules */&#xD;&#xA;EXEC dbo.CustomAdapterValidationExecuteRules&#xD;&#xA;	@ImportObjectID = @ImportObjectID,&#xD;&#xA;	@SourceTableName = '#LicenseAllocations',&#xD;&#xA;	@TraceField = 'ISNULL([License Name], ''&lt;NULL&gt;'') + ''/'' + ISNULL([User], ''&lt;NULL&gt;'')'&#xD;&#xA;" />
      <Object Type="License" Name="Lookup Licenses" Update="False" Create="False" OutputField="LicenseID">
        <Property Type="name" Name="Name" Update="Do not blank" ValueType="Field Value" Value="License Name" UseForMatching="True" Length="256" />
      </Object>
      <Object Type="User" Name="Lookup Users by Email" Update="False" Create="False" OutputField="UserID">
        <Property Type="email" Name="Email" Update="Do not blank" ValueType="Field Value" Value="User" UseForMatching="True" Length="200" />
      </Object>
      <Object Type="User" Name="Lookup Users by Employee Number" Update="False" Create="False" OutputField="UserID">
        <Property Type="employeenumber" Name="Employee Number" Update="Do not blank" ValueType="Field Value" Value="User" UseForMatching="True" Length="128" />
      </Object>
      <Object Type="Custom" Name="Validate Lookup Results" TimeOut="-1" Query="DECLARE @ImportObjectID INT&#xD;&#xA;EXEC @ImportObjectID = dbo.CustomAdapterValidationStartRules [LOG_IMPORT_ID], 'Validate Lookup Results'&#xD;&#xA;&#xD;&#xA;/* Validate license has been found */&#xD;&#xA;EXEC dbo.CustomAdapterValidationRegisterRule&#xD;&#xA;	@ImportObjectID,&#xD;&#xA;	@ValidationRule = 'source.LicenseID IS NULL',&#xD;&#xA;	@ErrorMessage = '@SourceColumn1Name@ [@SourceColumn1Value@] could not be found',&#xD;&#xA;	@SourceColumn1Name = 'License Name'&#xD;&#xA;&#xD;&#xA;/* Validate license records to be allocated are updatable by the operator */&#xD;&#xA;EXEC dbo.CustomAdapterValidationRegisterRule&#xD;&#xA;	@ImportObjectID,&#xD;&#xA;	@ValidationRule = '&#xD;&#xA;		source.LicenseID IS NOT NULL&#xD;&#xA;		AND NOT EXISTS( /* User does not have access to modify it */&#xD;&#xA;			SELECT	1&#xD;&#xA;			FROM	dbo.TableSoftwareLicenseCurrentUser(NULL, ''modify'', NULL, NULL) mod&#xD;&#xA;			WHERE	mod.SoftwareLicenseID = source.LicenseID&#xD;&#xA;		)&#xD;&#xA;	',&#xD;&#xA;	@ErrorMessage = 'You do not have rights to make changes to the existing license'&#xD;&#xA;&#xD;&#xA;/* Validate a user visible to the operator has been found for each allocation */&#xD;&#xA;EXEC dbo.CustomAdapterValidationRegisterRule&#xD;&#xA;	@ImportObjectID,&#xD;&#xA;	@ValidationRule = '&#xD;&#xA;		source.[User] != ''~''&#xD;&#xA;		AND NOT EXISTS(SELECT 1 FROM dbo.ComplianceUserCurrentUser u WHERE u.ComplianceUserID = source.UserID)&#xD;&#xA;	',&#xD;&#xA;	@ErrorMessage = '@SourceColum1Name@ [@SourceColumn1Value@] not found',&#xD;&#xA;	@SourceColumn1Name = 'User'&#xD;&#xA;&#xD;&#xA;/* Validate that user-based licenses are only allocated to users */&#xD;&#xA;EXEC dbo.CustomAdapterValidationRegisterRule&#xD;&#xA;	@ImportObjectID,&#xD;&#xA;	@ValidationRule = '&#xD;&#xA;		source.LicenseID IS NOT NULL&#xD;&#xA;		AND NOT EXISTS ( /* License cannot be allocated to users */&#xD;&#xA;			SELECT	1&#xD;&#xA;			FROM	dbo.SoftwareLicense sl&#xD;&#xA;				JOIN dbo.SoftwareLicenseType slt&#xD;&#xA;					ON slt.SoftwareLicenseTypeID = sl.LicenseTypeID&#xD;&#xA;					AND slt.DoesLicenseAllowUserAllocations = 1&#xD;&#xA;			WHERE	sl.SoftwareLicenseID = source.LicenseID&#xD;&#xA;		)&#xD;&#xA;	',&#xD;&#xA;	@ErrorMessage = 'License is of a type which cannot be allocated to users'&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;/* Execute validation rules */&#xD;&#xA;EXEC dbo.CustomAdapterValidationExecuteRules&#xD;&#xA;	@ImportObjectID = @ImportObjectID,&#xD;&#xA;	@SourceTableName = '#LicenseAllocations',&#xD;&#xA;	@TraceField = 'ISNULL([License Name], ''&lt;NULL&gt;'') + ''/'' + ISNULL([User], ''&lt;NULL&gt;'')'&#xD;&#xA;" />
      <Object Type="SoftwareLicenseAllocation" Name="Create Allocations to Users" Update="True" Create="True" OutputField="SoftwareAllocation_ID">
        <Property Type="complianceuserid" Name="User ID" Update="Do not blank" ValueType="Field Value" Value="UserID" UseForMatching="True" DataType="Integer" />
        <Property Type="softwarelicenseid" Name="License ID" Update="Do not blank" ValueType="Field Value" Value="LicenseID" UseForMatching="True" DataType="Integer" />
        <Property Type="softwarelicenseexemptionreason" Name="Exemption Reason" ValueType="Field Value" Value="Exemption Reason" Length="1000" />
        <Property Type="numberallocated" Name="Number allocated" Update="Do not blank" ValueType="Field Value" Value="Number Allocated" DataType="Integer" />
      </Object>
    </Import>
  </Imports>
</root>