<?xml version="1.0" encoding="utf-8"?>
<CustomReports>
  <Report ID="191" Exclude="" Action="add" FolderID="">
    <SearchName>ExportComputerOwnership</SearchName>
    <Description>Export FNMS Computer Ownership</Description>
    <FolderName>Exports</FolderName>
    <SearchSQL><![CDATA[
-- Avoid locking by allowing result to contain uncommitted rows
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

-- Set the language to us_english so the datetime is consistent
SET LANGUAGE us_english

-- Split search words
DECLARE @SearchWholeWord nvarchar(max)
SET     @SearchWholeWord = @SearchText
DECLARE @SearchWords table(Word nvarchar(400) PRIMARY KEY)
DECLARE @SearchWordCount int
IF      (@SearchText IS NOT NULL AND @SearchText <> '')
BEGIN
        INSERT  @SearchWords SELECT DISTINCT * FROM TableSplitSearchWords(@SearchWholeWord)
END
SELECT  @SearchWordCount = COUNT(DISTINCT Word) FROM @SearchWords

-- Pre-calculate computers that user is allowed access
	CREATE TABLE #ComplianceComputerAllowed (ComplianceComputerID int PRIMARY KEY)
	INSERT  #ComplianceComputerAllowed SELECT * FROM TableComplianceComputerCurrentUser(NULL, NULL, NULL, NULL)

-- Pre-calculate users that user is allowed access
	CREATE TABLE #ComplianceUserAllowed (ComplianceUserID int PRIMARY KEY)
	INSERT  #ComplianceUserAllowed SELECT * FROM TableComplianceUserCurrentUser(NULL, NULL, NULL, NULL, 1)

-- Limit rows returned if setting is present or provided row limit parameter not null
SET @RowLimit = dbo.MinRowLimit(@RowLimit, 'MaxCustomViewResultRows');
IF @RowLimit IS NULL OR @RowLimit = -1 BEGIN
    SET @RowLimit = 0x7FFFFFFF;
END
-- Custom view results query
SELECT  TOP(@RowLimit) results.*
FROM    (
                -- Custom view query for computers
                	SELECT  ComplianceComputer.ComplianceComputerID AS [ComputerID],
                        ComplianceComputer.ComputerName AS [ComputerName],
                        ComplianceComputer.SerialNo AS [SerialNo],
                        LocationLast.GroupName AS [LocationLast],
                        Location.Path AS [Location],
                        CorporateStructureLast.GroupName AS [CorporateStructureLast],
                        CorporateStructure.Path AS [CorporateStructure],
                        CostCenterLast.GroupName AS [CostCenterLast],
                        CostCenter.Path AS [CostCenter],
                        ComplianceComputerTypeI18N.DefaultValue AS [ComputerType],
                        ComplianceComputerInventorySourceTypeI18N.DefaultValue AS [InventorySourceType],
                        [R2_a7ee9be8f200fddb6c4e4c62234aa50a_ComputerToAssignedUser_UserID],
                        [R2_a7ee9be8f200fddb6c4e4c62234aa50a_ComputerToAssignedUser_UserName]
                	FROM    ComplianceComputerNotDummy AS ComplianceComputer
                			-- Filter
                			INNER JOIN #ComplianceComputerAllowed AS filter ON filter.ComplianceComputerID = ComplianceComputer.ComplianceComputerID
                			-- Additional joins
                			LEFT OUTER JOIN TableGroupExByLevel(1, NULL) AS LocationLast ON ComplianceComputer.LocationID = LocationLast.GroupExID
                        LEFT OUTER JOIN GroupEx AS Location ON ComplianceComputer.LocationID = Location.GroupExID
                        LEFT OUTER JOIN TableGroupExByLevel(2, NULL) AS CorporateStructureLast ON ComplianceComputer.BusinessUnitID = CorporateStructureLast.GroupExID
                        LEFT OUTER JOIN GroupEx AS CorporateStructure ON ComplianceComputer.BusinessUnitID = CorporateStructure.GroupExID
                        LEFT OUTER JOIN TableGroupExByLevel(3, NULL) AS CostCenterLast ON ComplianceComputer.CostCenterID = CostCenterLast.GroupExID
                        LEFT OUTER JOIN GroupEx AS CostCenter ON ComplianceComputer.CostCenterID = CostCenter.GroupExID
                        LEFT OUTER JOIN dbo.ComplianceComputerTypeI18N ON ComplianceComputerTypeI18N.ComplianceComputerTypeID = ComplianceComputer.ComplianceComputerTypeID
                        LEFT OUTER JOIN dbo.ComplianceComputerInventorySourceTypeI18N ON ComplianceComputerInventorySourceTypeI18N.ComplianceComputerInventorySourceTypeID = ComplianceComputer.ComplianceComputerInventorySourceTypeID
                        -- Link from Computer to Assigned User
                        	LEFT OUTER JOIN (
                        			-- Custom view query for users
                        				SELECT  ComplianceUser.ComplianceUserID AS [R2_a7ee9be8f200fddb6c4e4c62234aa50a_ComputerToAssignedUser_UserID],
                        			        ComplianceUser.UserName AS [R2_a7ee9be8f200fddb6c4e4c62234aa50a_ComputerToAssignedUser_UserName]
                        				FROM    ComplianceUser
                        						-- Filter
                        						INNER JOIN #ComplianceUserAllowed AS filter ON filter.ComplianceUserID = ComplianceUser.ComplianceUserID
                        						-- Additional joins
                        	) AS ComputerToAssignedUser ON ComputerToAssignedUser.R2_a7ee9be8f200fddb6c4e4c62234aa50a_ComputerToAssignedUser_UserID = ComplianceComputer.AssignedUserID
        ) AS results
WHERE   (@SearchWordCount = 0) OR
        (@SearchWordCount = (
                SELECT  COUNT(DISTINCT words.Word)
                FROM    @SearchWords AS words
                WHERE   [ComputerName] LIKE '%' + words.Word + '%' ESCAPE '\'
        )) OPTION (RECOMPILE)
]]></SearchSQL>
  </Report>
</CustomReports>