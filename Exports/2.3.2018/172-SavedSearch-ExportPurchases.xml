<?xml version="1.0" encoding="utf-8"?>
<CustomReports>
  <Report ID="172" Exclude="" Action="add" FolderID="">
    <SearchName>ExportPurchases</SearchName>
    <Description>Export FNMS Purchases</Description>
    <FolderName>Exports</FolderName>
    <SearchSQL><![CDATA[
-- Avoid locking by allowing result to contain uncommitted rows
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

-- Set the language to us_english so the datetime is consistent
SET LANGUAGE us_english

-- Split search words
DECLARE @SearchWholeWord nvarchar(max)
SET     @SearchWholeWord = @SearchText
DECLARE @SearchWords table(Word nvarchar(400) PRIMARY KEY)
DECLARE @SearchWordCount int
IF      (@SearchText IS NOT NULL AND @SearchText <> '')
BEGIN
        INSERT  @SearchWords SELECT DISTINCT * FROM TableSplitSearchWords(@SearchWholeWord)
END
SELECT  @SearchWordCount = COUNT(DISTINCT Word) FROM @SearchWords

-- Pre-calculate purchase order details that user is allowed access
	CREATE TABLE #PurchaseOrderDetailAllowed (PurchaseOrderDetailID int PRIMARY KEY)
	INSERT  #PurchaseOrderDetailAllowed
	SELECT  PurchaseOrderDetailID FROM TablePurchaseOrderDetailCurrentUser(NULL, NULL, NULL, NULL)

-- Pre-calculate purchase orders that user is allowed access
	CREATE TABLE #PurchaseOrderAllowed (PurchaseOrderID int PRIMARY KEY)
	INSERT  #PurchaseOrderAllowed SELECT * FROM TablePurchaseOrderCurrentUser(NULL, NULL, NULL, NULL)

-- Pre-calculate vendors that user is allowed access
	CREATE TABLE #VendorAllowed (VendorID int PRIMARY KEY)
	IF (SELECT HasAccess FROM dbo.RightsHasAccess('CMVendors', 'list')) = 1
	BEGIN
			INSERT  #VendorAllowed SELECT VendorID FROM Vendor
	END

-- Limit rows returned if setting is present or provided row limit parameter not null
SET @RowLimit = dbo.MinRowLimit(@RowLimit, 'MaxCustomViewResultRows');
IF @RowLimit IS NULL OR @RowLimit = -1 BEGIN
    SET @RowLimit = 0x7FFFFFFF;
END
-- Custom view results query
SELECT  TOP(@RowLimit) results.*
FROM    (
                -- Custom view query for purchase order details
                	SELECT  PurchaseOrderDetailInfo.PurchaseOrderDetailID AS [PurchaseOrderLineID],
                        PurchaseOrderDetailInfo.ItemDescription AS [Description],
                        PurchaseOrderDetailInfo.PurchaseOrderNo AS [PurchaseOrderNumber],
                        PurchaseOrderDetailInfo.SequenceNumber AS [SequenceNumber],
                        PurchaseOrderDetailTypeI18N.DefaultValue AS [PurchaseOrderDetailType],
                        PurchaseOrderDetailInfo.LicensePartNo AS [LicensePartNo],
                        PurchaseOrderDetailInfo.Quantity AS [Quantity],
                        PurchaseOrderDetailInfo.LicenseQuantity AS [LicenseQuantity],
                        PurchaseOrderStatusI18N.DefaultValue AS [PurchaseOrderStatus],
                        PurchaseOrderDetailInfo.PurchaseOrderDate AS [PurchaseOrderDate],
                        CAST(PurchaseOrderDetailInfo.PODetailSalesTax * SalesTaxRate.Rate AS money) AS [SalesTax],
                        PurchaseOrderDetailInfo.EffectiveQuantity AS [EffectiveQuantity],
                        CAST(PurchaseOrderDetailInfo.UnitPrice * UnitPriceRate.Rate AS money) AS [UnitPrice],
                        CAST(PurchaseOrderDetailInfo.PODetailTotalPrice * TotalPriceRate.Rate AS money) AS [TotalPrice],
                        PurchaseOrderDetailInfo.PODetailRequestNo AS [RequestNo],
                        PurchaseOrderDetailInfo.PODetailRequestDate AS [RequestDate],
                        PurchaseOrderDetailInfo.PODetailEffectiveDate AS [PODetailEffectiveDate],
                        PurchaseOrderDetailInfo.PODetailInvoiceNo AS [InvoiceNo],
                        PurchaseOrderDetailInfo.PODetailInvoiceDate AS [InvoiceDate],
                        PurchaseOrderDetailInfo.PODetailExpiryDate AS [PODetailExpiryDate],
                        CAST(PurchaseOrderDetailInfo.PODetailShippingAndHandling * ShippingAndHandlingRate.Rate AS money) AS [ShippingAndHandling],
                        ShippingLocation.Path AS [ShippingLocation],
                        ShippingMethodI18N.DefaultValue AS [ShippingMethod],
                        PurchaseOrderDetailInfo.PODetailShippingDate AS [ShippingDate],
                        [BusinessOwnerV].PropertyValue AS [BusinessOwner],
                        PurchaseOrderDetailInfo.PODetailComments AS [Comments],
                        [R2_ec0911f37b315a3e135dcf5200be0e0b_PurchaseOrderDetailToPurchaseOrder_PurchaseOrderID],
                        [R2_ec0911f37b315a3e135dcf5200be0e0b_PurchaseOrderDetailToPurchaseOrder_PurchaseOrderDescription],
                        [R2_ec0911f37b315a3e135dcf5200be0e0b_PurchaseOrderDetailToPurchaseOrder_PurchaseOrderNumber],
                        [R3_bb7985e76f8606ea89afc75cc0286498_PurchaseOrderToVendor_VendorID],
                        [R3_bb7985e76f8606ea89afc75cc0286498_PurchaseOrderToVendor_VendorName],
                			PurchaseOrderDetailInfo.PurchaseOrderID AS [PurchaseOrderID]
                	FROM    PurchaseOrderDetailWithPONoSKUMatching AS PurchaseOrderDetailInfo
                			-- Filter
                			INNER JOIN #PurchaseOrderDetailAllowed AS filter ON filter.PurchaseOrderDetailID = PurchaseOrderDetailInfo.PurchaseOrderDetailID
                			-- Additional joins
                			LEFT OUTER JOIN PurchaseOrder ON PurchaseOrder.PurchaseOrderID = PurchaseOrderDetailInfo.PurchaseOrderID
                        LEFT OUTER JOIN PurchaseOrderDetailTypeI18N ON PurchaseOrderDetailTypeI18N.PurchaseOrderDetailTypeID = PurchaseOrderDetailInfo.PurchaseOrderDetailTypeID
                        LEFT OUTER JOIN PurchaseOrderStatusI18N ON PurchaseOrderStatusI18N.PurchaseOrderStatusID = PurchaseOrderDetailInfo.PurchaseOrderStatusID
                        LEFT OUTER JOIN GetCurrencyExchangeRates(@CurrencyID) AS SalesTaxRate ON SalesTaxRate.CurrencyRateID = PurchaseOrderDetailInfo.PODetailSalesTaxRateID
                        LEFT OUTER JOIN GetCurrencyExchangeRates(@CurrencyID) AS UnitPriceRate ON UnitPriceRate.CurrencyRateID = PurchaseOrderDetailInfo.UnitPriceRateID
                        LEFT OUTER JOIN GetCurrencyExchangeRates(@CurrencyID) AS TotalPriceRate ON TotalPriceRate.CurrencyRateID = PurchaseOrderDetailInfo.PODetailTotalPriceRateID
                        LEFT OUTER JOIN GetCurrencyExchangeRates(@CurrencyID) AS ShippingAndHandlingRate ON ShippingAndHandlingRate.CurrencyRateID = PurchaseOrderDetailInfo.PODetailShippingAndHandlingRateID
                        LEFT OUTER JOIN GroupEx AS ShippingLocation ON PurchaseOrderDetailInfo.PODetailShippingLocationID = ShippingLocation.GroupExID
                        LEFT OUTER JOIN ShippingMethodI18N ON ShippingMethodI18N.ShippingMethodID = PurchaseOrderDetailInfo.PODetailShippingMethodID
                        LEFT OUTER JOIN dbo.PurchaseOrderDetailProperty [BusinessOwnerT] ON ([BusinessOwnerT].PropertyName = 'BusinessOwner')
                        LEFT OUTER JOIN dbo.PurchaseOrderDetailPropertyValue [BusinessOwnerV] ON ([BusinessOwnerV].PurchaseOrderDetailID = PurchaseOrderDetailInfo.PurchaseOrderDetailID AND [BusinessOwnerV].PurchaseOrderDetailPropertyID = [BusinessOwnerT].PurchaseOrderDetailPropertyID)
                        -- Link from PurchaseOrderDetail to Purchase Order
                        	LEFT OUTER JOIN (
                        			-- Custom view query for purchase orders
                        				SELECT  PurchaseOrder.PurchaseOrderID AS [R2_ec0911f37b315a3e135dcf5200be0e0b_PurchaseOrderDetailToPurchaseOrder_PurchaseOrderID],
                        			        PurchaseOrder.ShortDescription AS [R2_ec0911f37b315a3e135dcf5200be0e0b_PurchaseOrderDetailToPurchaseOrder_PurchaseOrderDescription],
                        			        PurchaseOrder.PurchaseOrderNo AS [R2_ec0911f37b315a3e135dcf5200be0e0b_PurchaseOrderDetailToPurchaseOrder_PurchaseOrderNumber],
                        			        [R3_bb7985e76f8606ea89afc75cc0286498_PurchaseOrderToVendor_VendorID],
                        			        [R3_bb7985e76f8606ea89afc75cc0286498_PurchaseOrderToVendor_VendorName]
                        				FROM    PurchaseOrder
                        						-- Filter
                        						INNER JOIN #PurchaseOrderAllowed AS filter ON filter.PurchaseOrderID = PurchaseOrder.PurchaseOrderID
                        						-- Additional joins
                        						-- Link from PurchaseOrder to Vendor
                        			        	LEFT OUTER JOIN (
                        			        			-- Custom view query for vendors
                        			        				SELECT  Vendor.VendorID AS [R3_bb7985e76f8606ea89afc75cc0286498_PurchaseOrderToVendor_VendorID],
                        			        			        Vendor.VendorName AS [R3_bb7985e76f8606ea89afc75cc0286498_PurchaseOrderToVendor_VendorName]
                        			        				FROM    Vendor
                        			        						-- Filter
                        			        						INNER JOIN #VendorAllowed AS filter ON filter.VendorID = Vendor.VendorID
                        			        						-- Additional joins
                        			        	) AS PurchaseOrderToVendor ON PurchaseOrderToVendor.R3_bb7985e76f8606ea89afc75cc0286498_PurchaseOrderToVendor_VendorID = PurchaseOrder.VendorID
                        	) AS PurchaseOrderDetailToPurchaseOrder ON PurchaseOrderDetailToPurchaseOrder.R2_ec0911f37b315a3e135dcf5200be0e0b_PurchaseOrderDetailToPurchaseOrder_PurchaseOrderID = PurchaseOrderDetailInfo.PurchaseOrderID
        ) AS results
WHERE   (@SearchWordCount = 0) OR
        (@SearchWordCount = (
                SELECT  COUNT(DISTINCT words.Word)
                FROM    @SearchWords AS words
                WHERE   ([Description] LIKE '%' + words.Word + '%' ESCAPE '\') OR
                        ([R2_ec0911f37b315a3e135dcf5200be0e0b_PurchaseOrderDetailToPurchaseOrder_PurchaseOrderDescription] LIKE '%' + words.Word + '%' ESCAPE '\') OR
                        ([R2_ec0911f37b315a3e135dcf5200be0e0b_PurchaseOrderDetailToPurchaseOrder_PurchaseOrderNumber] LIKE '%' + words.Word + '%' ESCAPE '\')
        )) OPTION (RECOMPILE)
]]></SearchSQL>
  </Report>
</CustomReports>