<?xml version="1.0" encoding="utf-8"?>
<CustomReports>
  <Report ID="114" Exclude="" Action="add" FolderID="">
    <SearchName>Assets with Purchase Orders</SearchName>
    <Description>unknown</Description>
    <FolderName>SAH Views</FolderName>
    <SearchSQL><![CDATA[
-- Avoid locking by allowing result to contain uncommitted rows
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

-- Set the language to us_english so the datetime is consistent
SET LANGUAGE us_english

-- Split search words
DECLARE @SearchWholeWord nvarchar(max)
SET     @SearchWholeWord = @SearchText
DECLARE @SearchWords table(Word nvarchar(400) PRIMARY KEY)
DECLARE @SearchWordCount int
IF      (@SearchText IS NOT NULL AND @SearchText <> '')
BEGIN
        INSERT  @SearchWords SELECT DISTINCT * FROM TableSplitSearchWords(@SearchWholeWord)
END
SELECT  @SearchWordCount = COUNT(DISTINCT Word) FROM @SearchWords

-- Pre-calculate assets that user is allowed access
	CREATE TABLE #AssetAllowed (AssetID int PRIMARY KEY)
	INSERT  #AssetAllowed SELECT * FROM TableAssetCurrentUser(NULL, NULL, NULL, NULL)

-- Pre-calculate computers that user is allowed access
	CREATE TABLE #ComplianceComputerAllowed (ComplianceComputerID int PRIMARY KEY)
	INSERT  #ComplianceComputerAllowed SELECT * FROM TableComplianceComputerCurrentUser(NULL, NULL, NULL, NULL)

-- Pre-calculate purchase order details that user is allowed access
	CREATE TABLE #PurchaseOrderDetailAllowedOrders (PurchaseOrderID int PRIMARY KEY)
	INSERT	#PurchaseOrderDetailAllowedOrders
	SELECT	PurchaseOrderID
	FROM	TablePurchaseOrderCurrentUser(NULL, NULL, NULL, NULL)

	CREATE TABLE #PurchaseOrderDetailAllowed (PurchaseOrderDetailID int PRIMARY KEY)
	INSERT  #PurchaseOrderDetailAllowed
	SELECT  allowed.PurchaseOrderDetailID FROM TablePurchaseOrderDetailCurrentUser(NULL, NULL, NULL, NULL) AS allowed
	JOIN	PurchaseOrderDetail AS pod ON pod.PurchaseOrderDetailID = allowed.PurchaseOrderDetailID
	JOIN    #PurchaseOrderDetailAllowedOrders AS po ON po.PurchaseOrderID = pod.PurchaseOrderID

-- Limit rows returned if setting is present or provided row limit parameter not null
SET @RowLimit = dbo.MinRowLimit(@RowLimit, 'MaxCustomViewResultRows');
IF @RowLimit IS NULL OR @RowLimit = -1 BEGIN
    SET @RowLimit = 0x7FFFFFFF;
END
-- Custom view results query
SELECT  TOP(@RowLimit) results.*
FROM    (
                -- Custom view query for assets
                	SELECT  Asset.AssetID AS [AssetID],
                        Asset.ShortDescription AS [ShortDescription],
                        AssetStatusI18N.StatusDefaultValue AS [AssetStatus],
                        ExternalComputers.LinkedToInventory AS [LinkedToInventory],
                        IsNull(LinkedToComputers.LinkedToComputer,0) AS [LinkedToComputer],
                        Asset.SerialNumber AS [SerialNumber],
                        AssetTypeI18N.AssetTypeName AS [AssetType],
                        [R2_5009de0ab767b80fc1b7bf5d8a32eb9f_AssetToComputer_ComputerID],
                        [R2_5009de0ab767b80fc1b7bf5d8a32eb9f_AssetToComputer_ComputerName],
                        [R2_0f14633007f239331887eab82ff8eb3d_AssetToPurchaseOrderDetail_PurchaseOrderLineID],
                        [R2_0f14633007f239331887eab82ff8eb3d_AssetToPurchaseOrderDetail_Description],
                        [R2_0f14633007f239331887eab82ff8eb3d_AssetToPurchaseOrderDetail_PurchaseOrderNumber],
                        [R2_0f14633007f239331887eab82ff8eb3d_AssetToPurchaseOrderDetail_PurchaseOrderDescription],
                        [R2_0f14633007f239331887eab82ff8eb3d_AssetToPurchaseOrderDetail_NumberOfAssets]
                	FROM    Asset
                			-- Filter
                			INNER JOIN #AssetAllowed AS filter ON filter.AssetID = Asset.AssetID
                			-- Additional joins
                			LEFT OUTER JOIN AssetStatusI18N ON AssetStatusI18N.AssetStatusID = Asset.AssetStatusID
                        LEFT OUTER JOIN (SELECT DISTINCT AssetID, CASE WHEN ccc.ComplianceComputerID IS NOT NULL THEN CONVERT(bit, 1) ELSE CONVERT(bit, 0) END AS LinkedToInventory FROM ComplianceComputer LEFT OUTER JOIN ComplianceComputerConnection AS ccc ON ccc.ComplianceComputerID = ComplianceComputer.ComplianceComputerID) AS ExternalComputers ON ExternalComputers.AssetID = Asset.AssetID
                        LEFT OUTER JOIN (SELECT AssetID, CONVERT(bit, 1) AS LinkedToComputer FROM ComplianceComputer WHERE ComplianceComputer.ComplianceComputerStatusID <> 4) AS LinkedToComputers ON LinkedToComputers.AssetID = Asset.AssetID
                        LEFT OUTER JOIN AssetTypeI18N ON AssetTypeI18N.AssetTypeID = Asset.AssetTypeID
                        -- Link from Asset to Computer
                        	LEFT OUTER JOIN (
                        			SELECT  Main.*,
                        					Extended.AssetID AS R2_5009de0ab767b80fc1b7bf5d8a32eb9f_AssetToComputer_ComplianceComputerLinkID
                        			FROM    (
                        							-- Custom view query for computers
                        								SELECT  ComplianceComputer.ComplianceComputerID AS [R2_5009de0ab767b80fc1b7bf5d8a32eb9f_AssetToComputer_ComputerID],
                        							        ComplianceComputer.ComputerName AS [R2_5009de0ab767b80fc1b7bf5d8a32eb9f_AssetToComputer_ComputerName]
                        								FROM    ComplianceComputer
                        										-- Filter
                        										INNER JOIN #ComplianceComputerAllowed AS filter ON filter.ComplianceComputerID = ComplianceComputer.ComplianceComputerID
                        										-- Additional joins
                        					) AS Main
                        					INNER JOIN ComplianceComputer AS Extended ON Extended.ComplianceComputerID = Main.R2_5009de0ab767b80fc1b7bf5d8a32eb9f_AssetToComputer_ComputerID
                        	) AS AssetToComputer ON AssetToComputer.R2_5009de0ab767b80fc1b7bf5d8a32eb9f_AssetToComputer_ComplianceComputerLinkID = Asset.AssetID
                        -- Link from Asset to Purchase Order Lines via AssetPurchaseOrder table
                        	LEFT OUTER JOIN (
                        			SELECT  AssetPurchaseOrder.AssetID,
                        					PurchaseOrderDetailInfo.*
                        			FROM    AssetPurchaseOrder
                        					INNER JOIN (
                        							-- Custom view query for purchase order details
                        								SELECT  PurchaseOrderDetailInfo.PurchaseOrderDetailID AS [R2_0f14633007f239331887eab82ff8eb3d_AssetToPurchaseOrderDetail_PurchaseOrderLineID],
                        							        PurchaseOrderDetailInfo.ItemDescription AS [R2_0f14633007f239331887eab82ff8eb3d_AssetToPurchaseOrderDetail_Description],
                        							        PurchaseOrderDetailInfo.PurchaseOrderNo AS [R2_0f14633007f239331887eab82ff8eb3d_AssetToPurchaseOrderDetail_PurchaseOrderNumber],
                        							        PurchaseOrderDetailInfo.ShortDescription AS [R2_0f14633007f239331887eab82ff8eb3d_AssetToPurchaseOrderDetail_PurchaseOrderDescription],
                        							        ISNULL(NumberOfAssetsCount.NumberOfAssets, 0) AS [R2_0f14633007f239331887eab82ff8eb3d_AssetToPurchaseOrderDetail_NumberOfAssets],
                        										PurchaseOrderDetailInfo.PurchaseOrderID AS [R2_0f14633007f239331887eab82ff8eb3d_AssetToPurchaseOrderDetail_PurchaseOrderID]
                        								FROM    PurchaseOrderDetailWithPONoSKUMatching AS PurchaseOrderDetailInfo
                        										-- Filter
                        										INNER JOIN #PurchaseOrderDetailAllowed AS filter ON filter.PurchaseOrderDetailID = PurchaseOrderDetailInfo.PurchaseOrderDetailID
                        										-- Additional joins
                        										LEFT OUTER JOIN PurchaseOrder ON PurchaseOrder.PurchaseOrderID = PurchaseOrderDetailInfo.PurchaseOrderID
                        							        LEFT OUTER JOIN (SELECT COUNT(DISTINCT AssetPurchaseOrder.AssetID) AS NumberOfAssets, AssetPurchaseOrder.PurchaseOrderDetailID FROM AssetPurchaseOrder INNER JOIN #AssetAllowed AS AssetPurchaseOrder_filter ON AssetPurchaseOrder_filter.AssetID = AssetPurchaseOrder.AssetID GROUP BY AssetPurchaseOrder.PurchaseOrderDetailID) AS NumberOfAssetsCount ON NumberOfAssetsCount.PurchaseOrderDetailID = PurchaseOrderDetailInfo.PurchaseOrderDetailID
                        					) AS PurchaseOrderDetailInfo ON PurchaseOrderDetailInfo.R2_0f14633007f239331887eab82ff8eb3d_AssetToPurchaseOrderDetail_PurchaseOrderLineID = AssetPurchaseOrder.PurchaseOrderDetailID
                        	) AS AssetToPurchaseOrderDetail ON AssetToPurchaseOrderDetail.AssetID = Asset.AssetID
        ) AS results
WHERE   (@SearchWordCount = 0) OR
        (@SearchWordCount = (
                SELECT  COUNT(DISTINCT words.Word)
                FROM    @SearchWords AS words
                WHERE   ([AssetID] LIKE '%' + words.Word + '%' ESCAPE '\') OR
                        ([ShortDescription] LIKE '%' + words.Word + '%' ESCAPE '\') OR
                        ([AssetStatus] LIKE '%' + words.Word + '%' ESCAPE '\') OR
                        ([LinkedToInventory] LIKE '%' + words.Word + '%' ESCAPE '\') OR
                        ([LinkedToComputer] LIKE '%' + words.Word + '%' ESCAPE '\') OR
                        ([SerialNumber] LIKE '%' + words.Word + '%' ESCAPE '\') OR
                        ([R2_5009de0ab767b80fc1b7bf5d8a32eb9f_AssetToComputer_ComputerID] LIKE '%' + words.Word + '%' ESCAPE '\') OR
                        ([R2_5009de0ab767b80fc1b7bf5d8a32eb9f_AssetToComputer_ComputerName] LIKE '%' + words.Word + '%' ESCAPE '\') OR
                        ([R2_0f14633007f239331887eab82ff8eb3d_AssetToPurchaseOrderDetail_Description] LIKE '%' + words.Word + '%' ESCAPE '\') OR
                        ([R2_0f14633007f239331887eab82ff8eb3d_AssetToPurchaseOrderDetail_PurchaseOrderNumber] LIKE '%' + words.Word + '%' ESCAPE '\') OR
                        ([R2_0f14633007f239331887eab82ff8eb3d_AssetToPurchaseOrderDetail_PurchaseOrderDescription] LIKE '%' + words.Word + '%' ESCAPE '\') OR
                        ([R2_0f14633007f239331887eab82ff8eb3d_AssetToPurchaseOrderDetail_NumberOfAssets] LIKE '%' + words.Word + '%' ESCAPE '\')
        )) OPTION (RECOMPILE)
]]></SearchSQL>
  </Report>
</CustomReports>