<?xml version="1.0" encoding="utf-8"?>
<CustomReports>
  <Report ID="169" Exclude="" Action="add" FolderID="">
    <SearchName>ExportLocalApplications</SearchName>
    <Description>Export FNMS Local Applications</Description>
    <FolderName>Exports</FolderName>
    <SearchSQL><![CDATA[
-- Avoid locking by allowing result to contain uncommitted rows
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

-- Set the language to us_english so the datetime is consistent
SET LANGUAGE us_english

-- Split search words
DECLARE @SearchWholeWord nvarchar(max)
SET     @SearchWholeWord = @SearchText
DECLARE @SearchWords table(Word nvarchar(400) PRIMARY KEY)
DECLARE @SearchWordCount int
IF      (@SearchText IS NOT NULL AND @SearchText <> '')
BEGIN
        INSERT  @SearchWords SELECT DISTINCT * FROM TableSplitSearchWords(@SearchWholeWord)
END
SELECT  @SearchWordCount = COUNT(DISTINCT Word) FROM @SearchWords

-- Pre-calculate software titles that user is allowed access
	CREATE TABLE #SoftwareTitleAllowed (SoftwareTitleID int PRIMARY KEY)
	IF (SELECT HasAccess FROM dbo.RightsHasAccess('CMApplications', 'list')) = 1
	BEGIN
			INSERT  #SoftwareTitleAllowed SELECT SoftwareTitleID FROM SoftwareTitle
	END

-- Pre-calculate software titles that match filter
	CREATE TABLE #SoftwareTitleFilter (SoftwareTitleID int PRIMARY KEY)
	INSERT  #SoftwareTitleFilter
	SELECT  DISTINCT SoftwareTitle.SoftwareTitleID
	FROM    SoftwareTitle
			INNER JOIN #SoftwareTitleAllowed AS st_allowed ON st_allowed.SoftwareTitleID = SoftwareTitle.SoftwareTitleID
			INNER JOIN SoftwareRecognitionFlexeraID() AS Recognition ON SoftwareTitle.SoftwareTitleID = Recognition.SoftwareTitleID
	WHERE   Recognition.FlexeraID NOT LIKE N'%arl%' ESCAPE '\' OR Recognition.FlexeraID IS NULL

-- Limit rows returned if setting is present or provided row limit parameter not null
SET @RowLimit = dbo.MinRowLimit(@RowLimit, 'MaxCustomViewResultRows');
IF @RowLimit IS NULL OR @RowLimit = -1 BEGIN
    SET @RowLimit = 0x7FFFFFFF;
END
-- Custom view results query
SELECT  TOP(@RowLimit) results.*
FROM    (
                -- Custom view query for software titles
                	SELECT  SoftwareTitle.SoftwareTitleID AS [ApplicationID],
                        SoftwareTitle.FullName AS [ApplicationName],
                        ISNULL(Edition.EditionName, '') AS [Edition],
                        SoftwareTitleVersion.VersionName AS [ApplicationVersion],
                        Product.ProductName AS [ProductName],
                        SoftwareTitlePublisher.PublisherName AS [Publisher],
                        SoftwareTitle.SKU AS [SKU],
                        SoftwareTitleClassificationI18N.DefaultValue AS [Classification],
                        Recognition.FlexeraID AS [FlexeraID],
                        SoftwareTitle.Comments AS [Comments]
                	FROM    SoftwareTitle
                			-- Filter
                			INNER JOIN #SoftwareTitleFilter AS filter ON filter.SoftwareTitleID = SoftwareTitle.SoftwareTitleID
                			-- Additional joins
                			LEFT OUTER JOIN SoftwareTitleEdition AS Edition ON SoftwareTitle.SoftwareTitleEditionID = Edition.SoftwareTitleEditionID
                        LEFT OUTER JOIN SoftwareTitleVersion ON SoftwareTitle.SoftwareTitleVersionID = SoftwareTitleVersion.SoftwareTitleVersionID
                        LEFT OUTER JOIN SoftwareTitleProduct AS Product ON SoftwareTitle.SoftwareTitleProductID = Product.SoftwareTitleProductID
                        INNER JOIN SoftwareTitleProduct ON SoftwareTitle.SoftwareTitleProductID = SoftwareTitleProduct.SoftwareTitleProductID LEFT OUTER JOIN SoftwareTitlePublisher ON SoftwareTitleProduct.SoftwareTitlePublisherID = SoftwareTitlePublisher.SoftwareTitlePublisherID
                        LEFT OUTER JOIN SoftwareTitleClassificationI18N ON SoftwareTitleClassificationI18N.SoftwareTitleClassificationID = SoftwareTitle.SoftwareTitleClassificationID
                        INNER JOIN SoftwareRecognitionFlexeraID() AS Recognition ON SoftwareTitle.SoftwareTitleID = Recognition.SoftwareTitleID
        ) AS results
WHERE   (@SearchWordCount = 0) OR
        (@SearchWordCount = (
                SELECT  COUNT(DISTINCT words.Word)
                FROM    @SearchWords AS words
                WHERE   [ApplicationName] LIKE '%' + words.Word + '%' ESCAPE '\'
        )) OPTION (RECOMPILE)
]]></SearchSQL>
  </Report>
</CustomReports>